---
title: "Empleando R como Sistema de Información Geográfica (SIG)"
author: "Gustavo Ahumada"
date: "Sept 13, 2019"
output:
  pdf_document: default
  html_document: default
---

# 1. Representación simple de datos espaciales

Los objetos espaciales usualmente son representados por datos tipo vector. Tales tipos de datos consisten en la geometría o la forma de los objetos. Por ejemplo, un conjunto de datos vector que contienen el limite de los paises del mundo (geometría) y también contienen su respectivo tamaño poblacional para el año 2010. Por otra parte, se tienen los datos espaciales continuos, los cuales son frecuentemente representados con datos tipo raster. A continuación se representante este tipo de datos utilizando R. Parte del codigo que será utilizado en esta sección está disponible en https://rspatial.org/spatial/index.html.

## 1.1. Datos tipo vector


```{r}
# Cargar librerias 
library(pacman)
pacman::p_load(raster, sf, maptools, rgdal, ggplot2, tidyverse, broom)
```


```{r}
# Creación de 10 estaciones climaticas (llamadas de A a J)
nombre <- LETTERS[1:10]
longitud <- c(-116.7, -120.4, -116.7, -113.5, -115.5,
              -120.8, -119.5, -113.7, -113.7, -110.7)
latitud <- c(45.3, 42.6, 38.9, 42.1, 35.7, 38.9,
             36.2, 39, 41.6, 36.9)
est_climatic<- cbind(longitud, latitud)
# Simulación de datos de precipitación
set.seed(0)
precip <-round((runif(length(latitud))*10)^3)
```


```{r}
nivel_precip <- 1 + precip/500
{plot(est_climatic, cex=nivel_precip, pch=20, col='blue', main='Precitación por estaciones')
# Adicionar etiquetas
text.default(est_climatic, nombre, pos = 4)
# Adicionar leyenda
breaks <- c(100, 250, 500, 1000)
legend.psize <- 1+breaks/500 
legend("topright", legend=breaks, pch=20, pt.cex=legend.psize, col='blue', bg='gray')}
```


```{r}
# Adicionar puntos, lineas y polígonos al plot.
{longitud <- c(-116.7, -120.4, -116.7, -113.5, -115.5,
              -120.8, -119.5, -113.7, -113.7, -110.7)
latitud <- c(45.3, 42.6, 38.9, 42.1, 35.7, 38.9,
             36.2, 39, 41.6, 36.9)
x <- cbind(longitud, latitud)
plot(est_climatic, main='Precipitación por estaciones')
polygon(x, col='blue', border='light blue')
lines(est_climatic, lwd=3, col='red')
points(x, cex=2, pch=20)
points(est_climatic, cex=nivel_precip, pch=20, col='red', main='Precipitation by station')}
```


```{r}
# Tabla de datos
tabla <- data.frame(longitud, latitud, nombre, precip)
tabla
```


## 1.2. Datos tipo raster


```{r}
# Crear esqueleto de una base de datos raster
rast <- raster(ncol=10, nrow=10, xmx=-80, xmn=-150, ymn=20, ymx=60)
rast
```


```{r}
# Asignar valores a objetos tipo raster
values(rast) <- runif(ncell(rast))
rast
```


```{r}
# Asignar el número de celdas 
values(rast) <- 1:ncell(rast)
rast
plot(rast)
```


```{r}
# Crear un esqueleto de una base de datos raster
{rast <- raster(ncol=10, nrow=10, xmx=-80, xmn=-150, ymn=20, ymx=60)
rast
# Asignar valores a objetos tipo raster
values(rast) <- runif(ncell(rast))
rast
# Asignar el número de celdas 
values(rast) <- 1:ncell(rast)
rast
# Plottear objeto tipo raster
plot(rast)
# Adicionar puntos y poligonos
longitud <- c(-116.8, -114.2, -112.9, -111.9, -114.2, -115.4, -117.7)
latitud <- c(41.3, 42.9, 42.4, 39.8, 37.6, 38.3, 37.6)
lonlat <- cbind(longitud, latitud)
pols <- spPolygons(lonlat, crs='+proj=longlat +datum=WGS84')
points(lonlat, col='red', pch=20, cex=3)
plot(pols, border='blue', lwd=2, add=TRUE)}
```


# 2. Datos de vectores geográficos en R


```{r setup}
# Definir directorio de trabajo
# en Windows sería algo a esto setwd("C:/Users/gusahu/Google Drive/Workshop_socher/Section_II")
knitr::opts_knit$set(root.dir = '/Users/gusahu/Google Drive/Workshop_GIS_with_R/Section_II')
```


```{r}
# Cargar librerias
library(pacman)
pacman::p_load(raster, rgdal, rgeos, tidyverse, stringr, sf)
```

```{r}
# Limpiar ambiente de trabajo
g <- gc(reset = TRUE)
rm(list = ls())
options(scipen = 999)
```


```{r}
# Importar archivos shape (archivos tipo vector)
mps <- shapefile('./data/mpios_geo_ok2.shp')
```


```{r}
# Plottear la geometría o el archivo .shp
plot(mps)
```

```{r}
# Realizar la unión (join) de una tabla con un shapefile
# importar archvios shape (archivos tipo vector)
shp <- st_read('./data/mpios_geo_ok.shp')
shp
```


```{r}
# Importar archivos en formato .csv (.xls)
tbl <- read_csv('./data/produccion_cacao.csv')
tbl
```


```{r}
# Años disponible en archivo .csv
yrs <- unique(tbl$PERIODO)
yrs
tbl <- tbl %>% # pipe (%>%) es un operador que permite encadenar funciones
  filter(PERIODO == 2017) %>% 
  mutate(MPIO = iconv(MPIO, to = 'latin1')) # transformación de variables en un data frame 
```


```{r}
# Ver atributos de objetos
str(tbl)
str(shp)
```


```{r}
# Transformación ID espacial
shp <- shp %>% 
  mutate(ID_ESPACIA = as.numeric(as.character(ID_ESPACIA)))
str(shp)
```


```{r}
# Realizar unión entre una table y un shapefile
fnl <- inner_join(x = shp, y = tbl, by = c('ID_ESPACIA' = 'COD_MUNI'))
fnl %>% 
  dplyr::select(PRODUCCION) %>% 
  plot() 
```


```{r warning=FALSE}
# Exportar el nuevo archivo espacial con las nuevas características
st_write(obj = fnl, dsn = './_shp', layer = 'producción_cacao', driver = 'ESRI shapefile')
```


# 3. Datos de ráster geográfico en R

## Descripción de los datos empleados
Los datos utilizados a lo largo de la sección 3 provienen de WorldClim-Global Data http://www.worldclim.org. Para esta sección empleamos datos climáticos para el año 2050 con una resolución de 10 minutos (tamaño de píxel de 20Km*20Km). El modelo climatico mediante el cual fueron construdios los datos es el modelo HadGEM2-CC bajo un escenario de alta probabilidad de ocurrencia. Para más información visitar https://portal.enes.org/models/earthsystem-models/metoffice-hadley-centre/hadgem2-es.


## 3.1 Manipulación de archivos tipo ráster 


```{r setup2}
# Definir directorio de trabajo
# en Windows sería algo a esto setwd("C:/Users/gusahu/Google Drive/Workshop_socher/Section_III")
knitr::opts_knit$set(root.dir = '/Users/gusahu/Google Drive/Workshop_GIS_with_R/Section_III')
```


```{r}
# Cargar librerias
library(pacman)
pacman::p_load(raster, rgdal, maptools)
```


```{r}
# Limpiar ambiente de trabajo 
g <- gc(reset = TRUE)
rm(list = ls())
options(scipen = 999)
```


```{r}
# Importar archivo raster de precipitación del mes de mayo
pr_mayo<- raster('./hg85pr50/hg85pr505.tif')
plot(pr_mayo)
```

```{r}
# Importar archivo raster de temperatura máxima del mes de mayo
tx_mayo<- raster('./hg85tx50/hg85tx505.tif')
plot(tx_mayo)
```


```{r}
# Cargar capa de polígono
{col<- readOGR('./shp_dpto/deptos_wgs84.shp') 
# Cortar raster al área del polígono
tx_mayo_col<- crop(tx_mayo,col)
#Plotear raster 
plot(tx_mayo_col, main = "Tmax. 2050 HadGEM CC RCP 8.5-Colombia (c*10)")
plot(col, add=TRUE)}
```


## 3.2 Operaciones entre rásteres - cálculo Indice de Aridez de Martonne (1926)

En esta sub-sección vamos a realizar algunar operaciones entre archivos ráster, y a través de estas operaciones realizaremós el cálculo del índice de ridez de Martanne ($I_m=P/(T_m+10)$). Para tal fin, llevaremos a cabo un conjunto de operaciones puntuales.  

Primer paso: cargar capas ráster.

```{r}
# cargar raster por lotes
grids<-list.files("./hg85tn50", pattern = ".tif", full.names = TRUE)  # temperatura mínima 
grids2<-list.files("./hg85tx50", pattern = ".tif", full.names = TRUE) # temperatura máxima
grids3<-list.files("./hg85pr50", pattern = ".tif", full.names = TRUE) # precipitación
```

```{r}
# crear raster stack 
tn_stack<- stack(grids)
tx_stack<- stack(grids2)
pr_stack<- stack(grids3)
```


Segundo paso: operar rásteres

```{r}
tn_promedio <- ((sum(tn_stack))/120) # temperatura minima promedio anual
tx_promedio <- ((sum(tx_stack))/120) # temperatura maxima promedio anual
tm_promedio <- mean(tn_promedio, tx_promedio) # cáulo temperatura media anual
pr_total <- sum(pr_stack) # precipitación acumulada anual
```


Tercer paso: cargar una capa vectorial de polígono

```{r}
col<- readOGR('./shp_dpto/deptos_wgs84.shp')
```


Cuarto paso: cortar raster al área del polígono

```{r}
pr_total_col<- crop(pr_total,col)
plot(pr_total_col)  # plot precipitación anual acumulada
```


```{r}
tm_promedio_col<- crop(tm_promedio,col)
plot(tm_promedio_col) # plot temperatura media anual
```


Quinto paso: calcular Índice de Aridez de Martonne para el año 2050


```{r}
ind_a <- pr_total_col / (tm_promedio_col + 10) 
plot(ind_a, main = "Índice de Aridez de Martonne año 2050-Colombia")
plot(col, add=TRUE) # adicionar capa vectorial de polígono
```


Sexto paso: exportar a *.tif


```{r}
writeRaster(ind_a, filename = "Ia_2050", format="GTiff", overwrite=TRUE)
```






